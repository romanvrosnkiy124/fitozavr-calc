<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–§–∏—Ç–æ–∑–∞–≤—Ä Dashboard</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            /* –¶–í–ï–¢–ê */
            --bg-color: var(--tg-theme-bg-color, #ffffff);
            --card-bg: var(--tg-theme-secondary-bg-color, rgb(252, 254, 255));
            --text-color: var(--tg-theme-text-color, #000000);
            --hint-color: var(--tg-theme-hint-color, #8e8e93);
            --button-color: var(--tg-theme-button-color, #3390ec);
            --button-text: var(--tg-theme-button-text-color, #ffffff);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0; padding: 15px;
            padding-bottom: 40px; /* –û—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É */
        }

        .card {
            background: var(--card-bg);
            border-radius: 14px; padding: 16px; margin-bottom: 12px;
            border: 1px solid rgba(0,0,0,0.05); box-shadow: 0 2px 8px rgba(0,0,0,0.02);
        }

        h2, h3 { margin-top: 0; margin-bottom: 8px; font-weight: 700; }
        h2 { font-size: 22px; }
        h3 { font-size: 17px; opacity: 0.95; }
        p { color: var(--hint-color); margin: 0; font-size: 15px; }

        .stat-row { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 15px; font-weight: 500;}
        .progress-bar { height: 8px; background: rgba(0, 0, 0, 0.05); border-radius: 4px; overflow: hidden; margin-top: 5px; }
        .progress-fill { height: 100%; transition: width 0.8s ease-out; }

        .food-list { list-style: none; padding: 0; margin: 0; }
        .food-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(0, 0, 0, 0.04); font-size: 15px; }
        .food-item:last-child { border-bottom: none; }
        .food-cals { font-weight: 600; color: var(--hint-color); }

        .btn {
            display: block; width: 100%; padding: 14px;
            background: var(--button-color); color: var(--button-text);
            text-align: center; border-radius: 12px; font-weight: 600;
            border: none; cursor: pointer; font-size: 17px; margin-top: 15px;
        }
        .btn:active { opacity: 0.8; transform: scale(0.98); }

        /* –°—Ç–∏–ª—å –¥–ª—è –≤—Ç–æ—Ä–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–π –∫–Ω–æ–ø–∫–∏ (PDF) */
        .btn-secondary {
            background: transparent;
            color: var(--button-color);
            border: 2px solid var(--button-color);
        }
    </style>
</head>
<body>

    <!-- –®–∞–ø–∫–∞ -->
    <div class="card">
        <h2 id="username">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
        <p id="goal">...</p>
    </div>

    <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å -->
    <div class="card">
        <div class="stat-row">
            <span>üî• –ö–∞–ª–æ—Ä–∏–∏</span>
            <span id="cals_val">0 / 0</span>
        </div>
        <div class="progress-bar"><div id="cals_bar" class="progress-fill" style="background: #ff9500; width: 0%"></div></div>
        
        <div style="margin-top: 20px;" class="stat-row">
            <span>üíß –í–æ–¥–∞</span>
            <span id="water_val">0 –º–ª</span>
        </div>
        <div class="progress-bar"><div id="water_bar" class="progress-fill" style="background: #007aff; width: 0%"></div></div>
    </div>

    <!-- –ì—Ä–∞—Ñ–∏–∫ –≤–µ—Å–∞ -->
    <div class="card">
        <h3>‚öñÔ∏è –î–∏–Ω–∞–º–∏–∫–∞ –≤–µ—Å–∞</h3>
        <canvas id="weightChart" style="max-height: 220px;"></canvas>
    </div>

    <!-- –ò—Å—Ç–æ—Ä–∏—è –µ–¥—ã -->
    <div class="card">
        <h3>üçΩ –°–µ–≥–æ–¥–Ω—è —Å—ä–µ–¥–µ–Ω–æ</h3>
        <ul id="food_list" class="food-list">
            <li class="food-item" style="justify-content: center; color: var(--hint-color); padding: 20px;">–ü–æ–∫–∞ –ø—É—Å—Ç–æ ü•ó</li>
        </ul>
    </div>

    <!-- –ö–ù–û–ü–ö–ò -->
    <button class="btn btn-secondary" id="pdfBtn">üìú –°–∫–∞—á–∞—Ç—å PDF –æ—Ç—á–µ—Ç</button>
    <button class="btn" onclick="Telegram.WebApp.close()">–ó–∞–∫—Ä—ã—Ç—å</button>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();

        // –û–ë–†–ê–ë–û–¢–ö–ê –ö–ù–û–ü–ö–ò PDF
        document.getElementById('pdfBtn').addEventListener('click', function(){
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –±–æ—Ç—É –∫–æ–º–∞–Ω–¥—É "generate_pdf"
            tg.sendData("generate_pdf");
        });

        // 1. –ü–∞—Ä—Å–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö
        const params = new URLSearchParams(window.location.search);
        
        const name = params.get('name') || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
        const goal = params.get('goal') || '–ù–µ—Ç —Ü–µ–ª–∏';
        const cals = parseInt(params.get('cals')) || 0;
        const water = parseInt(params.get('water')) || 0;
        const maxCals = parseInt(params.get('max_cals')) || 2000;

        let weightHistory = [];
        let mealsHistory = [];
        try {
            weightHistory = JSON.parse(decodeURIComponent(params.get('weights'))) || [];
            mealsHistory = JSON.parse(decodeURIComponent(params.get('meals'))) || [];
        } catch (e) { console.error("JSON Error", e); }

        // 2. UI
        document.getElementById('username').innerText = name;
        document.getElementById('goal').innerText = goal;
        document.getElementById('cals_val').innerText = `${cals} / ${maxCals}`;
        document.getElementById('water_val').innerText = `${water} –º–ª`;

        setTimeout(() => {
            let calsPercent = Math.min((cals / maxCals) * 100, 100);
            document.getElementById('cals_bar').style.width = calsPercent + '%';
            let waterPercent = Math.min((water / 2500) * 100, 100);
            document.getElementById('water_bar').style.width = waterPercent + '%';
        }, 150);

        // 3. –ï–¥–∞
        const foodListEl = document.getElementById('food_list');
        if (mealsHistory.length > 0) {
            foodListEl.innerHTML = ''; 
            mealsHistory.forEach(item => {
                let li = document.createElement('li');
                li.className = 'food-item';
                li.innerHTML = `<span>${item.n}</span><span class="food-cals">${item.c}</span>`;
                foodListEl.appendChild(li);
            });
        }

        // 4. –ì—Ä–∞—Ñ–∏–∫
        if (weightHistory.length > 0) {
            const ctx = document.getElementById('weightChart').getContext('2d');
            let gradient = ctx.createLinearGradient(0, 0, 0, 300);
            gradient.addColorStop(0, 'rgba(51, 144, 236, 0.4)');
            gradient.addColorStop(1, 'rgba(51, 144, 236, 0.0)');
            const labels = weightHistory.map(w => w.d);
            const dataPoints = weightHistory.map(w => w.w);

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '–í–µ—Å', data: dataPoints, borderColor: '#3390ec',
                        backgroundColor: gradient, borderWidth: 3,
                        pointBackgroundColor: '#ffffff', pointBorderColor: '#3390ec',
                        pointBorderWidth: 2, pointRadius: 4, fill: true, tension: 0.4
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { display: false }, ticks: { color: '#8e8e93', font: {size: 11} } },
                        y: { grid: { color: 'rgba(0, 0, 0, 0.04)', borderDash: [5, 5] }, ticks: { color: '#8e8e93', font: {size: 11} } }
                    }
                }
            });
        } else {
            document.getElementById('weightChart').style.display = 'none';
        }
    </script>
</body>
</html>
