<!doctype html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>–§–∏—Ç–æ–∑–∞–≤—Ä</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: #f4f7f9;
            --card-bg: #ffffff;
            --text-main: #000000;
            --text-secondary: #8e8e93;
            --accent-blue: #3390ec;
            --accent-orange: #ff8c00;
            --accent-light-blue: #e3f2fd;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            padding-bottom: 90px; /* –û—Ç—Å—Ç—É–ø –ø–æ–¥ –Ω–∞–≤–∏–≥–∞—Ü–∏—é */
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: var(--bg-color);
        }
        .header-title {
            text-align: center;
            flex-grow: 1;
        }
        .header-title h1 { margin: 0; font-size: 17px; font-weight: 600; }
        .header-title p { margin: 0; font-size: 12px; color: var(--text-secondary); }
        .btn-text { color: var(--accent-blue); cursor: pointer; font-size: 17px; text-decoration: none; border: none; background: none; padding: 0;}
        .plus-icon { font-size: 24px; color: var(--accent-blue); font-weight: 300; opacity: 0; } 

        .container { padding: 0 15px; }

        /* Card Base */
        .card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
        }

        /* Calories Section */
        .calories-grid { display: flex; align-items: center; gap: 20px; }
        .progress-circle {
            position: relative;
            width: 120px;
            height: 120px;
            flex-shrink: 0;
        }
        .progress-circle svg { transform: rotate(-90deg); width: 100%; height: 100%; }
        .progress-circle .bg { fill: none; stroke: #f0f0f0; stroke-width: 8; }
        .progress-circle .meter { 
            fill: none; stroke: var(--accent-orange); stroke-width: 8; 
            stroke-linecap: round; 
            stroke-dasharray: 314; 
            stroke-dashoffset: 314; 
            transition: stroke-dashoffset 1s ease-out;
        }
        .circle-text {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }
        .circle-text .val { font-size: 22px; font-weight: 800; line-height: 1.2; }
        .circle-text .goal { font-size: 10px; color: var(--text-secondary); }

        /* User Info inside Calories card */
        .user-block { display: flex; flex-direction: column; justify-content: center; }
        .label-text { color: var(--text-secondary); font-size: 13px; margin-bottom: 4px; }
        .username-text { font-size: 20px; font-weight: 700; line-height: 1.2; }

        /* Water Section */
        .water-header { display: flex; justify-content: space-between; margin-bottom: 15px; align-items: center; }
        .water-title { font-weight: 600; font-size: 17px; display: flex; align-items: center; gap: 8px;}
        .water-val { font-weight: 600; font-size: 17px; color: var(--accent-blue); }
        
        .water-buttons { display: flex; gap: 10px; }
        .btn-water {
            flex: 1; padding: 12px; border-radius: 14px; border: none;
            background: var(--accent-light-blue); color: var(--accent-blue);
            font-weight: 600; font-size: 15px; cursor: pointer;
            transition: opacity 0.2s;
        }
        .btn-water:active { opacity: 0.7; }

        /* Weight Section */
        .weight-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .weight-current { font-size: 22px; font-weight: 700; }
        .weight-info { font-size: 13px; color: var(--text-secondary); text-align: right; }
        
        /* –ì—Ä–∞—Ñ–∏–∫ (Canvas) */
        .chart-container { width: 100%; height: 60px; position: relative; }
        .weight-labels { display: flex; justify-content: space-between; font-size: 11px; color: #ccc; margin-top: 5px; }

        /* Food List */
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .section-title { font-weight: 600; font-size: 17px; }
        
        .food-list { list-style: none; padding: 0; margin: 0; }
        .food-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0; border-bottom: 1px solid #f0f0f0;
        }
        .food-item:last-child { border-bottom: none; }
        
        .food-info { display: flex; align-items: center; gap: 12px; }
        .food-icon { font-size: 22px; width: 30px; text-align: center; }
        .food-name { font-weight: 500; font-size: 16px; }
        .food-kcal { color: var(--text-secondary); font-size: 14px; font-weight: 500; }

        /* Main Buttons */
        .btn-main {
            width: 100%; padding: 16px; background: var(--accent-blue);
            color: white; border-radius: 16px; border: none;
            font-size: 17px; font-weight: 600; cursor: pointer; margin-top: 10px;
        }
        .btn-main:active { opacity: 0.9; }

        .btn-pdf {
            width: 100%; padding: 16px; background: transparent;
            color: var(--accent-blue); border-radius: 16px; 
            border: 2px solid rgba(51, 144, 236, 0.2);
            font-size: 17px; font-weight: 600; cursor: pointer; margin-top: 20px;
        }
        .btn-pdf:active { background: rgba(51, 144, 236, 0.05); }

        /* Bottom Nav */
        .nav-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
            display: flex; justify-content: space-around;
            padding: 10px 0 25px 0; border-top: 1px solid #e5e5e5;
            z-index: 100;
        }
        .nav-item { text-align: center; color: var(--text-secondary); font-size: 10px; flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: default; }
        .nav-item.active { color: var(--accent-blue); }
        .nav-icon { font-size: 22px; }

    </style>
</head>
<body>

    <div class="header">
        <button class="btn-text" onclick="Telegram.WebApp.close()">–ó–∞–∫—Ä—ã—Ç—å</button>
        <div class="header-title">
            <h1>–§–∏—Ç–æ–∑–∞–≤—Ä</h1>
            <p>–î–Ω–µ–≤–Ω–∏–∫ –ø–∏—Ç–∞–Ω–∏—è</p>
        </div>
        <div class="plus-icon"></div> 
    </div>

    <div class="container">
        <!-- –ö–∞–ª–æ—Ä–∏–∏ -->
        <div class="card">
            <div class="calories-grid">
                <div class="progress-circle">
                    <svg width="120" height="120">
                        <circle class="bg" cx="60" cy="60" r="50"></circle>
                        <circle id="circle-progress" class="meter" cx="60" cy="60" r="50"></circle>
                    </svg>
                    <div class="circle-text">
                        <div class="val" id="current-cal">0</div>
                        <div class="goal">–∏–∑ <span id="goal-cal">2000</span></div>
                    </div>
                </div>
                <div class="user-block">
                    <div class="label-text">–ê–∫–∫–∞—É–Ω—Ç</div>
                    <div class="username-text" id="username">–ì–æ—Å—Ç—å</div>
                    <div class="label-text" id="goal-text" style="margin-top: 5px;">...</div>
                </div>
            </div>
        </div>

        <!-- –í–æ–¥–∞ -->
        <div class="card">
            <div class="water-header">
                <div class="water-title">üíß –í–æ–¥–∞</div>
                <div class="water-val" id="water-val">0 –º–ª</div>
            </div>
            <div class="water-buttons">
                <button class="btn-water" onclick="addWater(250)">+ 250 –º–ª</button>
                <button class="btn-water" onclick="addWater(500)">+ 500 –º–ª</button>
            </div>
        </div>

        <!-- –í–µ—Å -->
        <div class="card">
            <div class="weight-header">
                <div style="font-weight: 600; font-size: 17px;">‚öñÔ∏è –í–µ—Å</div>
                <div>
                    <div class="weight-current" id="current-weight">--</div>
                    <div class="weight-info" id="weight-diff">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>
                </div>
            </div>
            <!-- –ì—Ä–∞—Ñ–∏–∫ Chart.js -->
            <div class="chart-container">
                <canvas id="weightChart"></canvas>
            </div>
            <div class="weight-labels">
                <span>7 –¥–Ω–µ–π –Ω–∞–∑–∞–¥</span>
                <span>–°–µ–≥–æ–¥–Ω—è</span>
            </div>
        </div>

        <!-- –ï–¥–∞ -->
        <div class="card">
            <div class="section-header">
                <div class="section-title">üçΩ –°–µ–≥–æ–¥–Ω—è —Å—ä–µ–¥–µ–Ω–æ</div>
            </div>
            <div id="food-list-container">
                <div class="food-item" style="color: #ccc; justify-content: center;">
                    –°–ø–∏—Å–æ–∫ –ø—É—Å—Ç
                </div>
            </div>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
        <button class="btn-pdf" id="pdfBtn">üìÑ –°–∫–∞—á–∞—Ç—å –æ—Ç—á–µ—Ç PDF</button>
        <button class="btn-main" onclick="Telegram.WebApp.close()">–ì–æ—Ç–æ–≤–æ</button>
    </div>

    <!-- –ù–∏–∂–Ω–µ–µ –º–µ–Ω—é (–≤–∏–∑—É–∞–ª—å–Ω–æ–µ) -->
    <div class="nav-bar">
        <div class="nav-item active"><span class="nav-icon">üè†</span>–°–µ–≥–æ–¥–Ω—è</div>
        <div class="nav-item"><span class="nav-icon">üïí</span>–ò—Å—Ç–æ—Ä–∏—è</div>
        <div class="nav-item"><span class="nav-icon">üìä</span>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</div>
        <div class="nav-item"><span class="nav-icon">üë§</span>–ü—Ä–æ—Ñ–∏–ª—å</div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.setHeaderColor('#f4f7f9'); 
        tg.setBackgroundColor('#f4f7f9');

        // --- –õ–û–ì–ò–ö–ê ---
        const params = new URLSearchParams(window.location.search);
        const name = params.get('name') || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
        const goal = params.get('goal') || '–¶–µ–ª—å';
        const cals = parseInt(params.get('cals')) || 0;
        const water = parseInt(params.get('water')) || 0;
        const maxCals = parseInt(params.get('max_cals')) || 2000;

        let weightHistory = [], mealsHistory = [];
        try {
            weightHistory = JSON.parse(decodeURIComponent(params.get('weights'))) || [];
            mealsHistory = JSON.parse(decodeURIComponent(params.get('meals'))) || [];
        } catch (e) { console.error("JSON Error", e); }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
        document.getElementById('username').innerText = name;
        document.getElementById('goal-text').innerText = goal;
        document.getElementById('current-cal').innerText = cals;
        document.getElementById('goal-cal').innerText = maxCals;
        document.getElementById('water-val').innerText = water + " –º–ª";

        // –ê–Ω–∏–º–∞—Ü–∏—è –∫—Ä—É–≥–∞
        setTimeout(() => {
            const circle = document.getElementById('circle-progress');
            const radius = 50;
            const circumference = 2 * Math.PI * radius;
            const percent = Math.min(cals / maxCals, 1);
            const offset = circumference - (percent * circumference);
            circle.style.strokeDashoffset = offset;
            if (cals > maxCals) circle.style.stroke = '#ff3b30';
        }, 100);

        // –í–µ—Å
        if (weightHistory.length > 0) {
            const lastW = weightHistory[weightHistory.length - 1].w;
            document.getElementById('current-weight').innerText = lastW + " –∫–≥";
            if (weightHistory.length > 1) {
                const diff = (lastW - weightHistory[0].w).toFixed(1);
                const sign = diff > 0 ? "+" : "";
                document.getElementById('weight-diff').innerText = `${sign}${diff} –∫–≥ –∑–∞ 7 –¥–Ω–µ–π`;
                document.getElementById('weight-diff').style.color = diff <= 0 ? '#34c759' : '#ff3b30';
            }
        }

        // –ì—Ä–∞—Ñ–∏–∫
        if (weightHistory.length > 0) {
            const ctx = document.getElementById('weightChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: weightHistory.map(w => w.d),
                    datasets: [{
                        data: weightHistory.map(w => w.w),
                        borderColor: '#3390ec', borderWidth: 2,
                        pointRadius: 0, pointHoverRadius: 4, fill: false, tension: 0.4
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { x: { display: false }, y: { display: false } },
                    layout: { padding: 5 }
                }
            });
        }

        // –ï–¥–∞
        const listContainer = document.getElementById('food-list-container');
        if (mealsHistory.length > 0) {
            listContainer.innerHTML = '';
            const icons = ['ü•©', 'ü•ó', 'üçé', 'ü•ò', 'üç≤', 'ü•ñ', 'üç≥', 'ü•õ']; 
            mealsHistory.forEach(item => {
                const div = document.createElement('div');
                div.className = 'food-item';
                const icon = icons[Math.floor(Math.random() * icons.length)];
                div.innerHTML = `<div class="food-info"><span class="food-icon">${icon}</span><span class="food-name">${item.n}</span></div><div class="food-kcal">${item.c} –∫–∫–∞–ª</div>`;
                listContainer.appendChild(div);
            });
        }

        // –ö–Ω–æ–ø–∫–∏
        function addWater(amount) {
            tg.HapticFeedback.impactOccurred('light');
            tg.sendData(`add_water_${amount}`);
            let current = parseInt(document.getElementById('water-val').innerText);
            document.getElementById('water-val').innerText = (current + amount) + " –º–ª";
        }

        document.getElementById('pdfBtn').addEventListener('click', function(){
            tg.HapticFeedback.notificationOccurred('success');
            tg.sendData("generate_pdf");
            tg.close();
        });

    </script>
</body>
</html>
